<% content_for :title, @question.label %>

<%= stylesheet_link_tag "featherlight.min.css" %>
<%= javascript_include_tag "featherlight" %>

<%= stylesheet_link_tag "toastr.css" %>
<%= javascript_include_tag "toastr" %>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=visualization"></script>
<%= javascript_include_tag "markerwithlabel" %>


<% if @question == nil %>
<% @question = Question.where(slug: params[:id])[0] %>
<% end %>

<%@tag_array = Tag.where(question_id: @question.id).order(created_at: :asc)%>

<script>
$(document).ready(function() {

  toastr.options = {
    "closeButton": true,
    "debug": false,
    "newestOnTop": false,
    "progressBar": false,
    "positionClass": "toast-top-right",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "0",
    "hideDuration": "0",
    "timeOut": "0",
    "extendedTimeOut": "0",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "slideDown",
    "hideMethod": "slideUp"
  }

  //setTimeout(function(){toastr["info"]( "Arima helps you to visualize opinions thru simple clicks."); }, 4200);

  $('#answer_value').on('change', function() {
    $('.modal-button').prop('disabled', !(this.value.length > 0));
  });

  $('#answer_value').on('input', function() {
    $('.modal-button').prop('disabled', !(this.value.length > 0));
  });
  <%if @question.image_link.nil? %>
    $(".question-title").css("width", "60%");
    $(".answer-counter").css("width", "80%");
  <%end%>
});
</script>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.4";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<% if flash[:share_modal] %>
  <script>
    $(document).ready(function() {
      $('#shareNewQuestionModal').modal('show');
    });
  </script>
<% end %>
<%# if flash[:share_answer_modal] && !user_signed_in? %>
  <!--<script>
  //   $(document).ready(function() {
  //     setTimeout(function() {
  //       $('#shareSignupModal').modal('show');
  //     }, 10000);
  //   });
  </script>-->
<%# end %>

<script type="text/javascript">
  function FindPosition(oElement)
    {
    if(typeof( oElement.offsetParent ) != "undefined")
      {
        for(var posX = 0, posY = 0; oElement; oElement = oElement.offsetParent)
        {
          posX += oElement.offsetLeft;
          posY += oElement.offsetTop;
        }
          return [ posX, posY ];
        }
        else
        {
          return [ oElement.x, oElement.y ];
        }
    }
  function GetCoordinates(e)
    {
      var PosX = 0;
      var PosY = 0;
      var ImgPos;
      ImgPos = FindPosition(myImg);
      if (!e) var e = window.event;
      if (e.pageX || e.pageY)
      {
        PosX = e.pageX;
        PosY = e.pageY;
      }
      else if (e.clientX || e.clientY)
        {
          PosX = e.clientX + document.body.scrollLeft
            + document.documentElement.scrollLeft;
          PosY = e.clientY + document.body.scrollTop
            + document.documentElement.scrollTop;
        }
      PosX = PosX - ImgPos[0];
      PosY = PosY - ImgPos[1];
      document.getElementById("x").innerHTML = PosX;
      document.getElementById("y").innerHTML = PosY;

      document.getElementById('x_axis').value = PosX;
      document.getElementById('y_axis').value = PosY;
  }

</script>

<%= render '/common/share_new_question_modal' %>
<%#= render '/common/missing_input_signup'%>
<%= render 'common/user_list_display' %>
<%#= render '/common/signup_modal' %>
<%#= render '/common/share_answer_modal' %>

<%#if cookies[:unlocked] != "" && cookies[:unlocked] != nil%>
<!--  <div id="achievement_box">
    <span id='close' onclick='document.getElementById("achievement_box").style.display = "none"; return false;' style="display: inline-block; float: right; padding:2px 5px; color: white;">x</span>
    <p id="thankyou_msg">Thanks for answering!</p>
    <p id="unlocked_msg">You unlocked the "<%#= Badge.where(badge_id: cookies[:unlocked].to_i).first.label%>" badge</p>
    <%#= image_tag "Badges/#{cookies[:unlocked]}.png", :id => "image1", size: "100x100" %>

  </div>

  <%#cookies[:unlocked] = nil%>
-->
<%#end%>

<%if @user_submitted_answer && !@question.shared_image.nil? && !@question.shared_image%>
  <div class="main-site-container" id="question-page-container">

    <div id="question-hero">
      <div class="question-container">
        <!-- Votes -->
        <div class="question-vote-container">
          <!-- Should probably refactor this and use _question_normal -->
          <div class="question-upvote hidden-xs">
            <% if (cookies[:guest].nil?) %>
              <% check_guest() %>
            <% end %>
            <% if Vote.where(:user_id => cookies[:guest]).where(:question_id => @question.id).pluck(:vote_type)[0] == "upvote" %>
              <%= link_to image_tag('upvote_blue.png', id: "upvote-image-#{@question.id}", class: "question-vote-image"), upvote_question_path(:id => @question.id), :method => :put, :remote => true %>
            <% else %>
              <%= link_to image_tag('upvote_grey.png', id: "upvote-image-#{@question.id}", class: "question-vote-image"), upvote_question_path(:id => @question.id), :method => :put, :remote => true %>
            <% end %>
          </div>

          <div id="votecount-<%= @question.id %>" class="question-vote-counter hidden-xs">
            <%= "#{@question.votecount}" %>
          </div>

          <div class="question-downvote hidden-xs">
            <% if Vote.where(:user_id => cookies[:guest]).where(:question_id => @question.id).pluck(:vote_type)[0] == "downvote" %>
              <%= link_to image_tag('downvote_orange.png', id: "downvote-image-#{@question.id}", class: "question-vote-image"), downvote_question_path(:id => @question.id), :method => :put, :remote => true %>
            <% else %>
              <%= link_to image_tag('downvote_grey.png', id: "downvote-image-#{@question.id}", class: "question-vote-image"), downvote_question_path(:id => @question.id), :method => :put, :remote => true %>
            <% end %>
          </div>
          <!-- Should probably refactor this and use _question_normal -->
        </div>

        <%if !@question.image_link.nil? %>
          <div style="float:left; margin-right: 20px;"><%= image_tag("/system/uploads/" + @question.image_link, size: "100x100", alt:"image",class: "question_image")%></div>
        <%end%>
        <!-- Question Title and Answer Box -->
        <div class="question-title-container">
          <h1 class="question-title"><%= @question.label %></h1>
          <div class="answer-counter"><%= @question.answers.count %><%= @question.answers.count == 1 ? ' Person' : ' People' %> Answered
          </div>
        </div>
      </div>

        <!-- Counter + Share Section -->
        <div id="question-meta-container" class="hidden-xs">
              <%= render partial: "questions/share", locals: {
                  id: @question.id,
                  url: "#{request.protocol}#{request.host_with_port}" + question_path(@question),
                  title: "#{@question.label[0..70]}...",
                  image: "#{request.protocol}#{request.host_with_port}" + question_path(@question)
                }%>
        </div>
        <div id="Social-like-button" class="hidden-xs">
            <!--Facebook like button-->
            <div class="fb-like" data-href="https://www.facebook.com/friendsofarima?fref=ts"
            data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
            <br>
            <!--Twitter like button-->
            <a class="twitter-follow-button twitter-count" data-show-screen-name="false"
            href="https://twitter.com/arima_io">
            Follow @TwitterDev</a>
        </div>


    </div>

    <!-- Report -->
    <div id="question-content-container">
      <div class="report-container">
        <%= render partial: 'common/visualization', locals: { question: @question, answer: @answer} %>

         <div id="comment_list_container" class="hidden-xs">
          <%= render partial: "comment_list"%>
        </div>
      </div>
    </div>

    <div id="trending-questions-container" class="hidden-xs">
      <% @random_questions = Question.where(group_id: @question.group_id).order("RANDOM()").limit(5) %>
        <br>
        <br>
        <p class="trending-questions-label hidden-xs">Questions You May Like:</p>
      <% @random_questions.each do |random_question| %>
        <%= render partial: 'common/trending_question', locals: { question: random_question } %>
      <% end %>
      <a href="<%= feed_path %>"><div id="view-feed-button" class="hidden-xs">View More</div></a>
      <%#= link_to 'View Category', cat_path(:group_id), :id => "view-feed-button" %>

    </div>
  </div>

<%elsif @question.shared_image && @question.value_type == "tag"%>
  <div class="share-image-container" style="margin-left: 200px;">
    <div class="image-frame">
      <div class="image-container">
        <%if !@question.image_link.nil?%>
          <%img_path = "/system/uploads/" + @question.image_link%>
          <%if !@question.image_link.nil? && @question.image_link[0] == "<"%>
            <div class="hidden-xs" style="margin-left:150px;"></iframe><%= @question.image_link.html_safe%></div>
            <div class="visible-xs"><%= @question.image_link.html_safe%></div>
          <%else%>
            <!--<a href="<%= img_path %>" data-featherlight="image">-->
              <%= @question.image_link.nil? ? "" : image_tag("/system/uploads/" + @question.image_link, alt:"image", class: "shared-photo", id: "lightbox") %>
            <!--</a>-->
          <%end%>
        <%end%>

          <script type="text/javascript">
            var myImg = document.getElementById("lightbox");
            myImg.onmousedown = GetCoordinates;
            var img = document.getElementById('lightbox');
            var xwidth = img.clientWidth;
            var yheight = img.clientHeight;

            $('#lightbox').click(function(){
                document.getElementById('x_axis_max').value = xwidth;
                document.getElementById('y_axis_max').value = yheight;
            });
          </script>

      </div>

      <div style="clear:both;"></div>

      <!--<a href="<%= feed_path %>" class="feed-link hidden-xs"><div id="back-to-feed-button"><%= image_tag("Back-Arrow.png", class: "feed-back-arrow", width: "19", height: "9")%><font class="feed-back-title">Back to Home Feed</font></div></a>-->

      <div style="width: 100%" class="hidden">
        <section class="share-icon-container" style="float: right;" class="hidden-xs">
          <%= render partial: "questions/share", locals: {
              id: @question.id,
              url: "#{request.protocol}#{request.host_with_port}" + question_path(@question),
              title: "#{@question.label[0..70]}...",
              image: "#{request.protocol}#{request.host_with_port}" + question_path(@question)
            }%>
        </section>
      </div>
    </div>

    <div id="tag_show_mobile" class="visible-xs">
      <div style="width: 100%; text-align: center;">
        <section class="share-image-title"><%=@question.label %></section>
        <section class="question-author">
          by
          <%=
          if User.where(id: @question.user_id).first.username.nil? || User.where(id: @question.user_id).first.username.empty?
            "anonymous"
          else
            link_to User.where(id: @question.user_id).first.username, custom_show_path(:username => User.where(id: @question.user_id).first.username)
          end
           %>
          <%= link_to " #{@counter} users voted", { controller: "questions", action: "user_list_display", remote: true, :question => @question }, id: 'users_list' %>
        </section>
      </div>
      <%if !@question.shared_image.nil? && @question.shared_image %>
        <div id="tag_list_container" style="background-color: #F6F6F6;">
          <%= render partial: "tag_list"%>
        </div>
      <%elsif !@question.shared_image.nil? && !@question.shared_image%>
        <%= render partial: 'questions/answer_input', locals: { question: @question, answer: @answer} %>
      <%end%>
    </div>
  </div>
<%else %>
  <div id="<%= @question.image_link.nil? ? "question_poll" : "image_poll" %>">
    <center>
      <%if !@question.image_link.nil?%>
        <%img_path = "/system/uploads/" + @question.image_link%>

        <a href="<%= img_path %>" data-featherlight="image">
          <%= @question.image_link.nil? ? "" : image_tag("/system/uploads/" + @question.image_link, alt:"image", class: "shared-photo", id: "lightbox") %>
        </a>
      <%end%>
    </center>

    <center style="color: #4a4a4a; font-weight: bold; font-family: Roboto; font-size: 26px; padding-top: 20px; margin: 0 22%;"><%=@question.label %></center>

    <center class="meta-title"><%= @question.answers.count%><%= @question.answers.count == 1 ? ' Person' : ' People' %> Answered</center>
    <br>
    <center>
      <%= render partial: 'questions/answer_input', locals: { question: @question, answer: @answer} %>
    </center>

  </div>
<%end%>
